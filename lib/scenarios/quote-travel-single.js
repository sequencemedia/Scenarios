'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _extends2=require('babel-runtime/helpers/extends');var _extends3=_interopRequireDefault(_extends2);var _objectWithoutProperties2=require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _puppeteer=require('puppeteer');var _puppeteer2=_interopRequireDefault(_puppeteer);var _path=require('path');var _path2=_interopRequireDefault(_path);var _moment=require('moment');var _moment2=_interopRequireDefault(_moment);var _fsExtra=require('fs-extra');var _logger=require('../logger');var _logger2=_interopRequireDefault(_logger);var _network2=require('../client/network');var _network3=_interopRequireDefault(_network2);var _travel=require('./travel');var _step1EnterSingleDates=require('./travel/step1/step1-enter-single-dates');var _step1EnterSingleDates2=_interopRequireDefault(_step1EnterSingleDates);var _step1EnterProfile=require('./travel/step1/step1-enter-profile');var _step1EnterProfile2=_interopRequireDefault(_step1EnterProfile);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var step2=_travel.step2.step2;var step3=_travel.step3.step3;var step4=_travel.step4.step4;var step1=function(){var _ref=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee(_ref2){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var page=_ref2.page,config=(0,_objectWithoutProperties3.default)(_ref2,['page']);var _ref3$message,message;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return page.waitForSelector('[data-step-index="1"]',{visible:true});case 3:_context.next=5;return page.click('[data-step-index="1"]');case 5:_context.next=7;return(0,_step1EnterSingleDates2.default)((0,_extends3.default)({},config,{page:page}),params);case 7:_context.next=9;return(0,_step1EnterProfile2.default)((0,_extends3.default)({},config,{page:page}),params);case 9:_context.next=11;return page.click('[data-step-index="1"] button.cta-button');case 11:_context.next=18;break;case 13:_context.prev=13;_context.t0=_context['catch'](0);_ref3$message=_context.t0.message;message=_ref3$message===undefined?'No error message is defined':_ref3$message;_logger2.default.error('Error in Step 1. '+message.trim());case 18:case'end':return _context.stop();}}},_callee,undefined,[[0,13]]);}));return function step1(_x){return _ref.apply(this,arguments);};}();exports.default=function(){var _ref4=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee2(){var _ref5=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},env=_ref5.env,_ref5$lang=_ref5.lang,lang=_ref5$lang===undefined?'en':_ref5$lang,_ref5$headless=_ref5.headless,headless=_ref5$headless===undefined?true:_ref5$headless,_ref5$w=_ref5.w,width=_ref5$w===undefined?1024:_ref5$w,_ref5$h=_ref5.h,height=_ref5$h===undefined?768:_ref5$h,scenario=_ref5.scenario,_ref5$timestamp=_ref5.timestamp,timestamp=_ref5$timestamp===undefined?new Date():_ref5$timestamp,_ref5$iteration=_ref5.iteration,iteration=_ref5$iteration===undefined?0:_ref5$iteration;var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var now,dir,browser,page,client,_network,attach,detach,config,_ref6$message,message;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:now=(0,_moment2.default)(timestamp).format('YYYYMMDD-HHmmss');dir=_path2.default.resolve(iteration?'./log/'+scenario+'/'+now+'/'+iteration:'./log/'+scenario+'/'+now);_context2.next=4;return _puppeteer2.default.launch({headless:headless,args:['--window-size='+width+','+height]});case 4:browser=_context2.sent;_context2.next=7;return browser.newPage();case 7:page=_context2.sent;_context2.next=10;return page.setViewport({width:width,height:height});case 10:_context2.next=12;return page.goto('http://'+env+'/'+lang+'/quote');case 12:_context2.next=14;return page.target().createCDPSession();case 14:client=_context2.sent;_context2.next=17;return client.send('Emulation.clearDeviceMetricsOverride');case 17:_network=(0,_network3.default)(client),attach=_network.attach,detach=_network.detach;_context2.next=20;return attach();case 20:/* END NETWORK MONITORING */config={browser:browser,page:page,client:client,env:env,lang:lang,headless:headless,w:width,h:height,scenario:scenario,timestamp:timestamp,iteration:iteration,now:now,dir:dir};_context2.prev=21;_context2.next=24;return(0,_travel.single)(config,params);case 24:_context2.next=26;return page.waitForNavigation();case 26:_context2.next=28;return step1(config,params);case 28:_context2.next=30;return step2(config,params);case 30:_context2.next=32;return step3(config,params);case 32:_context2.next=34;return step4(config,params);case 34:_context2.next=36;return page.waitForNavigation();case 36:_context2.next=38;return(0,_travel.altapay)(config,params);case 38:_context2.next=40;return page.waitForNavigation({waitUntil:['networkidle2','load']});case 40:_context2.next=51;break;case 42:_context2.prev=42;_context2.t0=_context2['catch'](21);_ref6$message=_context2.t0.message;message=_ref6$message===undefined?'No error message is defined':_ref6$message;_logger2.default.error('Error in scenario \''+scenario+'\'. '+message.trim());_context2.next=49;return(0,_fsExtra.ensureDir)(dir);case 49:_context2.next=51;return page.screenshot({path:dir+'/'+scenario+'.png',fullPage:true,clip:{x:0,y:0,width:width,height:height}});case 51:_context2.prev=51;_context2.next=54;return detach();case 54:_context2.next=56;return browser.close();case 56:return _context2.finish(51);case 57:case'end':return _context2.stop();}}},_callee2,undefined,[[21,42,51,57]]);}));return function(){return _ref4.apply(this,arguments);};}();