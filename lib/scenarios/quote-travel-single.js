'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _map=require('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _extends2=require('babel-runtime/helpers/extends');var _extends3=_interopRequireDefault(_extends2);var _objectWithoutProperties2=require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _puppeteer=require('puppeteer');var _puppeteer2=_interopRequireDefault(_puppeteer);var _path=require('path');var _path2=_interopRequireDefault(_path);var _chalk=require('chalk');var _chalk2=_interopRequireDefault(_chalk);var _moment=require('moment');var _moment2=_interopRequireDefault(_moment);var _fsExtra=require('fs-extra');var _logger=require('../logger');var _logger2=_interopRequireDefault(_logger);var _transformUrl=require('../transform-url');var _transformUrl2=_interopRequireDefault(_transformUrl);var _travel=require('./travel');var _step1EnterSingleDates=require('./travel/step1/step1-enter-single-dates');var _step1EnterSingleDates2=_interopRequireDefault(_step1EnterSingleDates);var _step1EnterProfile=require('./travel/step1/step1-enter-profile');var _step1EnterProfile2=_interopRequireDefault(_step1EnterProfile);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var step2=_travel.step2.step2;var step3=_travel.step3.step3;var step4=_travel.step4.step4;var step1=function(){var _ref=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee(_ref2){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var page=_ref2.page,config=(0,_objectWithoutProperties3.default)(_ref2,['page']);var _ref3$message,message;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return page.waitForSelector('[data-step-index="1"]',{visible:true});case 3:_context.next=5;return(0,_step1EnterSingleDates2.default)((0,_extends3.default)({},config,{page:page}),params);case 5:_context.next=7;return(0,_step1EnterProfile2.default)((0,_extends3.default)({},config,{page:page}),params);case 7:_context.next=9;return page.click('[data-step-index="1"] button.cta-button');case 9:_context.next=16;break;case 11:_context.prev=11;_context.t0=_context['catch'](0);_ref3$message=_context.t0.message;message=_ref3$message===undefined?'No error message is defined':_ref3$message;_logger2.default.error('Error in Step 1. '+message.trim());case 16:case'end':return _context.stop();}}},_callee,undefined,[[0,11]]);}));return function step1(_x){return _ref.apply(this,arguments);};}();exports.default=function(){var _ref4=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee4(){var _ref5=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},env=_ref5.env,_ref5$lang=_ref5.lang,lang=_ref5$lang===undefined?'en':_ref5$lang,_ref5$headless=_ref5.headless,headless=_ref5$headless===undefined?true:_ref5$headless,_ref5$w=_ref5.w,width=_ref5$w===undefined?1024:_ref5$w,_ref5$h=_ref5.h,height=_ref5$h===undefined?768:_ref5$h,scenario=_ref5.scenario,_ref5$timestamp=_ref5.timestamp,timestamp=_ref5$timestamp===undefined?new Date():_ref5$timestamp,_ref5$iteration=_ref5.iteration,iteration=_ref5$iteration===undefined?0:_ref5$iteration;var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var now,dir,browser,page,requestMap,client,getResponseBody,onNetworkRequestWillBeSent,onNetworkResponseReceived,onNetworkLoadingFailed,onNetworkLoadingFinished,config,_ref12$message,message;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:now=(0,_moment2.default)(timestamp).format('YYYYMMDD-HHmmss');dir=_path2.default.resolve(iteration?'./log/'+scenario+'/'+now+'/'+iteration:'./log/'+scenario+'/'+now);_context4.next=4;return _puppeteer2.default.launch({headless:headless,args:['--window-size='+width+','+height]});case 4:browser=_context4.sent;_context4.next=7;return browser.newPage();case 7:page=_context4.sent;_context4.next=10;return page.setViewport({width:width,height:height});case 10:_context4.next=12;return page.goto('http://'+env+'/'+lang+'/quote');case 12:/* BEGIN NETWORK MONITORING */requestMap=new _map2.default();_context4.next=15;return page.target().createCDPSession();case 15:client=_context4.sent;_context4.next=18;return client.send('Emulation.clearDeviceMetricsOverride');case 18:getResponseBody=function(){var _ref6=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee2(requestId){var _ref7,body;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return client.send('Network.getResponseBody',{requestId:requestId});case 2:_ref7=_context2.sent;body=_ref7.body;return _context2.abrupt('return',body);case 5:case'end':return _context2.stop();}}},_callee2,undefined);}));return function getResponseBody(_x5){return _ref6.apply(this,arguments);};}();onNetworkRequestWillBeSent=function onNetworkRequestWillBeSent(){var event=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _event$request=event.request,url=_event$request.url,method=_event$request.method;if(url.includes('omtrdc')&&method==='POST'){var requestId=event.requestId,request=event.request;requestMap.set(requestId,request);_logger2.default.info(_chalk2.default.cyan('Network.requestWillBeSent'),'\n',{requestId:requestId,url:(0,_transformUrl2.default)(url),method:method});}};onNetworkResponseReceived=function onNetworkResponseReceived(_ref8){var requestId=_ref8.requestId,_ref8$response=_ref8.response,url=_ref8$response.url,status=_ref8$response.status,statusText=_ref8$response.statusText;if(requestMap.has(requestId)){_logger2.default.info(_chalk2.default.cyan('Network.responseReceived'),'\n',{requestId:requestId,url:(0,_transformUrl2.default)(url),status:status,statusText:statusText});}};onNetworkLoadingFailed=function(){var _ref9=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee3(){var _ref10=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var requestId=_ref10.requestId,response=(0,_objectWithoutProperties3.default)(_ref10,['requestId']);return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!requestMap.has(requestId)){_context3.next=9;break;}_context3.t0=_logger2.default;_context3.t1=_chalk2.default.red('Network.loadingFailed');_context3.t2=(0,_extends3.default)({},response,{requestId:requestId});_context3.next=6;return getResponseBody(requestId);case 6:_context3.t3=_context3.sent;_context3.t0.info.call(_context3.t0,_context3.t1,'\n',_context3.t2,_context3.t3);requestMap.delete(requestId);case 9:case'end':return _context3.stop();}}},_callee3,undefined);}));return function onNetworkLoadingFailed(){return _ref9.apply(this,arguments);};}();onNetworkLoadingFinished=function onNetworkLoadingFinished(_ref11){var requestId=_ref11.requestId;// , ...response }) => { // Logger.info('Network.loadingFinished', { requestId, ...response });
if(requestMap.has(requestId)){_logger2.default.info(_chalk2.default.cyan('Network.loadingFinished'),'\n',{requestId:requestId});requestMap.delete(requestId);}};client.on('Network.requestWillBeSent',onNetworkRequestWillBeSent);client.on('Network.responseReceived',onNetworkResponseReceived);client.on('Network.loadingFailed',onNetworkLoadingFailed);client.on('Network.loadingFinished',onNetworkLoadingFinished);_context4.next=29;return client.send('Network.enable');case 29:/* END NETWORK MONITORING */config={browser:browser,page:page,client:client,env:env,lang:lang,headless:headless,w:width,h:height,scenario:scenario,timestamp:timestamp,iteration:iteration,now:now,dir:dir};_context4.prev=30;_context4.next=33;return(0,_travel.single)(config,params);case 33:_context4.next=35;return page.waitForNavigation();case 35:_context4.next=37;return step1(config,params);case 37:_context4.next=39;return step2(config,params);case 39:_context4.next=41;return step3(config,params);case 41:_context4.next=43;return step4(config,params);case 43:_context4.next=45;return page.waitForNavigation();case 45:_context4.next=47;return(0,_travel.altapay)(config,params);case 47:_context4.next=49;return page.waitForNavigation({waitUntil:['networkidle2','load']});case 49:_context4.next=60;break;case 51:_context4.prev=51;_context4.t0=_context4['catch'](30);_ref12$message=_context4.t0.message;message=_ref12$message===undefined?'No error message is defined':_ref12$message;_logger2.default.error('Error in scenario \''+scenario+'\'. '+message.trim());_context4.next=58;return(0,_fsExtra.ensureDir)(dir);case 58:_context4.next=60;return page.screenshot({path:dir+'/'+scenario+'.png',fullPage:true});case 60:_context4.prev=60;_context4.next=63;return client.send('Network.disable');case 63:client.removeListener('Network.requestWillBeSent',onNetworkRequestWillBeSent);client.removeListener('Network.responseReceived',onNetworkResponseReceived);client.removeListener('Network.loadingFailed',onNetworkLoadingFailed);client.removeListener('Network.loadingFinished',onNetworkLoadingFinished);/* END NETWORK MONITORING */_context4.next=69;return browser.close();case 69:return _context4.finish(60);case 70:case'end':return _context4.stop();}}},_callee4,undefined,[[30,51,60,70]]);}));return function(){return _ref4.apply(this,arguments);};}();