'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _extends2=require('babel-runtime/helpers/extends');var _extends3=_interopRequireDefault(_extends2);var _objectWithoutProperties2=require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _puppeteer=require('puppeteer');var _puppeteer2=_interopRequireDefault(_puppeteer);var _fsExtra=require('fs-extra');var _getNow=require('../get-now');var _getNow2=_interopRequireDefault(_getNow);var _getDir=require('../get-dir');var _getDir2=_interopRequireDefault(_getDir);var _logger=require('../logger');var _logger2=_interopRequireDefault(_logger);var _network=require('../client/network');var _network2=_interopRequireDefault(_network);var _writer=require('../client/network/writer');var _writer2=_interopRequireDefault(_writer);var _travel=require('./travel');var _step1EnterSingleDates=require('./travel/step1/step1-enter-single-dates');var _step1EnterSingleDates2=_interopRequireDefault(_step1EnterSingleDates);var _step1EnterProfile=require('./travel/step1/step1-enter-profile');var _step1EnterProfile2=_interopRequireDefault(_step1EnterProfile);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var step2=_travel.step2.step2;// import chalk from 'chalk';
var step3=_travel.step3.step3;var step4=_travel.step4.step4;var step1=function(){var _ref=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee(_ref2){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var page=_ref2.page,config=(0,_objectWithoutProperties3.default)(_ref2,['page']);var _ref3$message,message,dir;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return page.waitForSelector('[data-step-index="1"]',{visible:true});case 3:_context.next=5;return page.click('[data-step-index="1"]');case 5:_context.next=7;return(0,_step1EnterSingleDates2.default)((0,_extends3.default)({},config,{page:page}),params);case 7:_context.next=9;return(0,_step1EnterProfile2.default)((0,_extends3.default)({},config,{page:page}),params);case 9:_context.next=11;return page.click('[data-step-index="1"] button.cta-button');case 11:_context.next=23;break;case 13:_context.prev=13;_context.t0=_context['catch'](0);_ref3$message=_context.t0.message;message=_ref3$message===undefined?'No error message is defined':_ref3$message;_logger2.default.error('Error in Step 1. '+message.trim());dir=config.dir;_context.next=21;return(0,_fsExtra.ensureDir)(dir);case 21:_context.next=23;return page.screenshot({path:dir+'/step-1.png',fullPage:true});case 23:case'end':return _context.stop();}}},_callee,undefined,[[0,13]]);}));return function step1(_x){return _ref.apply(this,arguments);};}();exports.default=function(){var _ref4=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee2(){var _ref5=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},env=_ref5.env,_ref5$lang=_ref5.lang,lang=_ref5$lang===undefined?'en':_ref5$lang,_ref5$headless=_ref5.headless,headless=_ref5$headless===undefined?true:_ref5$headless,_ref5$w=_ref5.w,width=_ref5$w===undefined?1024:_ref5$w,_ref5$h=_ref5.h,height=_ref5$h===undefined?768:_ref5$h,scenario=_ref5.scenario,_ref5$timestamp=_ref5.timestamp,timestamp=_ref5$timestamp===undefined?new Date():_ref5$timestamp,_ref5$iteration=_ref5.iteration,iteration=_ref5$iteration===undefined?0:_ref5$iteration,_ref5$now=_ref5.now,now=_ref5$now===undefined?(0,_getNow2.default)(timestamp):_ref5$now,_ref5$dir=_ref5.dir,dir=_ref5$dir===undefined?(0,_getDir2.default)(iteration,scenario,now):_ref5$dir,_ref5$captureNetwork=_ref5.captureNetwork,captureNetwork=_ref5$captureNetwork===undefined?false:_ref5$captureNetwork;var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var browser,page,client,config,networkEvents,_ref6$message,message,_ref7$message;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _puppeteer2.default.launch({headless:headless,args:['--window-size='+width+','+height]});case 2:browser=_context2.sent;_context2.next=5;return browser.newPage();case 5:page=_context2.sent;_context2.next=8;return page.setViewport({width:width,height:height});case 8:_context2.next=10;return page.target().createCDPSession();case 10:client=_context2.sent;_context2.next=13;return client.send('Emulation.clearDeviceMetricsOverride');case 13:config={browser:browser,page:page,client:client,env:env,lang:lang,headless:headless,w:width,h:height,scenario:scenario,timestamp:timestamp,iteration:iteration,now:now,dir:dir};networkEvents=void 0;_context2.prev=15;_network.map.clear();if(!captureNetwork){_context2.next=21;break;}networkEvents=(0,_network2.default)(config);_context2.next=21;return networkEvents.attach();case 21:_context2.next=23;return page.goto('https://'+env+'/'+lang+'/quote',{waitUntil:['networkidle2','load']});case 23:_context2.next=25;return(0,_travel.single)(config,params);case 25:_context2.next=27;return page.waitForNavigation({waitUntil:['networkidle0','networkidle2','load']});case 27:_context2.next=29;return step1(config,params);case 29:_context2.next=31;return step2(config,params);case 31:_context2.next=33;return step3(config,params);case 33:_context2.next=35;return step4(config,params);case 35:_context2.next=37;return page.waitForNavigation({waitUntil:['networkidle2','load']});case 37:_context2.next=39;return(0,_travel.altapay)(config,params);case 39:_context2.next=41;return page.waitForNavigation({waitUntil:['networkidle2','load']});case 41:_context2.next=43;return(0,_fsExtra.ensureDir)(dir);case 43:_context2.next=45;return page.screenshot({path:dir+'/step-4-confirmation.png',fullPage:true});case 45:_context2.next=56;break;case 47:_context2.prev=47;_context2.t0=_context2['catch'](15);_ref6$message=_context2.t0.message;message=_ref6$message===undefined?'No error message is defined':_ref6$message;_logger2.default.error('Error in scenario \''+scenario+'\'. '+message.trim());_context2.next=54;return(0,_fsExtra.ensureDir)(dir);case 54:_context2.next=56;return page.screenshot({path:dir+'/'+scenario+'.png',fullPage:true});case 56:_context2.prev=56;if(!captureNetwork){_context2.next=62;break;}_context2.next=60;return networkEvents.detach();case 60:_context2.next=62;return(0,_writer2.default)();case 62:return _context2.finish(56);case 63:_context2.prev=63;_context2.next=66;return browser.close();case 66:_context2.next=73;break;case 68:_context2.prev=68;_context2.t1=_context2['catch'](63);_ref7$message=_context2.t1.message;message=_ref7$message===undefined?'No error message is defined':_ref7$message;_logger2.default.error('Error calling \'browser.close()\' in \''+scenario+'\'. '+message.trim());case 73:case'end':return _context2.stop();}}},_callee2,undefined,[[15,47,56,63],[63,68]]);}));return function(){return _ref4.apply(this,arguments);};}();