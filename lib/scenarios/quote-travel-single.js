'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends2=require('babel-runtime/helpers/extends');var _extends3=_interopRequireDefault(_extends2);var _objectWithoutProperties2=require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2);var _map=require('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _puppeteer=require('puppeteer');var _puppeteer2=_interopRequireDefault(_puppeteer);var _travel=require('./travel');var _step1EnterSingleDates=require('./travel/step1/step1-enter-single-dates');var _step1EnterSingleDates2=_interopRequireDefault(_step1EnterSingleDates);var _step1EnterProfile=require('./travel/step1/step1-enter-profile');var _step1EnterProfile2=_interopRequireDefault(_step1EnterProfile);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}/* eslint no-console: "off" */var step2=_travel.step2.step2;var step3=_travel.step3.step3;var step4=_travel.step4.step4;var step1=function(){var _ref=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee(page){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return page.waitForSelector('[data-step-index="1"]',{visible:true});case 2:_context.next=4;return(0,_step1EnterSingleDates2.default)(page,params);case 4:_context.next=6;return(0,_step1EnterProfile2.default)(page,params);case 6:_context.next=8;return page.click('[data-step-index="1"] button.cta-button');case 8:case'end':return _context.stop();}}},_callee,undefined);}));return function step1(_x){return _ref.apply(this,arguments);};}();exports.default=function(){var _ref2=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee4(){var _ref3=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},env=_ref3.env,_ref3$lang=_ref3.lang,lang=_ref3$lang===undefined?'en':_ref3$lang,_ref3$headless=_ref3.headless,headless=_ref3$headless===undefined?true:_ref3$headless,_ref3$w=_ref3.w,width=_ref3$w===undefined?1024:_ref3$w,_ref3$h=_ref3.h,height=_ref3$h===undefined?768:_ref3$h;var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var browser,page,requestMap,client,transformUrl,getResponseBody,onNetworkRequestWillBeSent,onNetworkResponseReceived,onNetworkLoadingFailed,onNetworkLoadingFinished,_ref10$message,message;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _puppeteer2.default.launch({headless:headless,args:['--window-size='+width+','+height]});case 2:browser=_context4.sent;_context4.next=5;return browser.newPage();case 5:page=_context4.sent;_context4.next=8;return page.setViewport({width:width,height:height});case 8:_context4.next=10;return page.goto('http://'+env+'/'+lang+'/quote');case 10:/* BEGIN NETWORK MONITORING */requestMap=new _map2.default();_context4.next=13;return page.target().createCDPSession();case 13:client=_context4.sent;_context4.next=16;return client.send('Emulation.clearDeviceMetricsOverride');case 16:transformUrl=function transformUrl(url){return url.includes('?')?url.substr(0,url.indexOf('?')):url;};getResponseBody=function(){var _ref4=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee2(requestId){var _ref5,body;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return client.send('Network.getResponseBody',{requestId:requestId});case 2:_ref5=_context2.sent;body=_ref5.body;return _context2.abrupt('return',body);case 5:case'end':return _context2.stop();}}},_callee2,undefined);}));return function getResponseBody(_x5){return _ref4.apply(this,arguments);};}();onNetworkRequestWillBeSent=function onNetworkRequestWillBeSent(){var event=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _event$request=event.request,url=_event$request.url,method=_event$request.method;if(url.includes('omtrdc')&&method==='POST'){var requestId=event.requestId,request=event.request;requestMap.set(requestId,request);console.info('Network.requestWillBeSent',{requestId:requestId,url:transformUrl(url),method:method});}};onNetworkResponseReceived=function onNetworkResponseReceived(_ref6){var requestId=_ref6.requestId,_ref6$response=_ref6.response,url=_ref6$response.url,status=_ref6$response.status,statusText=_ref6$response.statusText;if(requestMap.has(requestId)){console.info('Network.responseReceived',{requestId:requestId,url:transformUrl(url),status:status,statusText:statusText});}};onNetworkLoadingFailed=function(){var _ref7=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee3(_ref8){var requestId=_ref8.requestId,response=(0,_objectWithoutProperties3.default)(_ref8,['requestId']);return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!requestMap.has(requestId)){_context3.next=8;break;}_context3.t0=console;_context3.t1=(0,_extends3.default)({},response,{requestId:requestId});_context3.next=5;return getResponseBody(requestId);case 5:_context3.t2=_context3.sent;_context3.t0.info.call(_context3.t0,'Network.loadingFailed',_context3.t1,_context3.t2);requestMap.delete(requestId);case 8:case'end':return _context3.stop();}}},_callee3,undefined);}));return function onNetworkLoadingFailed(_x7){return _ref7.apply(this,arguments);};}();onNetworkLoadingFinished=function onNetworkLoadingFinished(_ref9){var requestId=_ref9.requestId;if(requestMap.has(requestId)){console.info('Network.loadingFinished',{requestId:requestId});requestMap.delete(requestId);}};client.on('Network.requestWillBeSent',onNetworkRequestWillBeSent);client.on('Network.responseReceived',onNetworkResponseReceived);client.on('Network.loadingFailed',onNetworkLoadingFailed);client.on('Network.loadingFinished',onNetworkLoadingFinished);_context4.next=28;return client.send('Network.enable');case 28:_context4.prev=28;_context4.next=31;return(0,_travel.single)(page,params);case 31:_context4.next=33;return page.waitForNavigation();case 33:_context4.next=35;return step1(page,params);case 35:_context4.next=37;return step2(page,params);case 37:_context4.next=39;return step3(page,params);case 39:_context4.next=41;return step4(page,params);case 41:_context4.next=43;return page.waitForNavigation();case 43:_context4.next=45;return(0,_travel.altapay)(page,params);case 45:_context4.next=47;return page.waitForNavigation({waitUntil:['networkidle2','load']});case 47:_context4.next=54;break;case 49:_context4.prev=49;_context4.t0=_context4['catch'](28);_ref10$message=_context4.t0.message;message=_ref10$message===undefined?'No error message is defined':_ref10$message;console.error('Error in scenario `quote-travel-single`. '+message.trim());case 54:_context4.prev=54;_context4.next=57;return client.send('Network.disable');case 57:client.removeListener('Network.requestWillBeSent',onNetworkRequestWillBeSent);client.removeListener('Network.responseReceived',onNetworkResponseReceived);client.removeListener('Network.loadingFailed',onNetworkLoadingFailed);client.removeListener('Network.loadingFinished',onNetworkLoadingFinished);/* END NETWORK MONITORING */_context4.next=63;return browser.close();case 63:return _context4.finish(54);case 64:case'end':return _context4.stop();}}},_callee4,undefined,[[28,49,54,64]]);}));return function(){return _ref2.apply(this,arguments);};}();