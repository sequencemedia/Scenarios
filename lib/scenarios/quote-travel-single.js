'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends2=require('babel-runtime/helpers/extends');var _extends3=_interopRequireDefault(_extends2);var _objectWithoutProperties2=require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2);var _map=require('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _puppeteer=require('puppeteer');var _puppeteer2=_interopRequireDefault(_puppeteer);var _travel=require('./travel');var _step1EnterSingleDates=require('./travel/step1/step1-enter-single-dates');var _step1EnterSingleDates2=_interopRequireDefault(_step1EnterSingleDates);var _step1EnterProfile=require('./travel/step1/step1-enter-profile');var _step1EnterProfile2=_interopRequireDefault(_step1EnterProfile);var _logger=require('../logger');var _logger2=_interopRequireDefault(_logger);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var step2=_travel.step2.step2;var step3=_travel.step3.step3;var step4=_travel.step4.step4;var transformUrl=function transformUrl(){var url=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'';return url.includes('?')?url.substr(0,url.indexOf('?')):url;};var step1=function(){var _ref=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee(page){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var _ref2$message,message;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return page.waitForSelector('[data-step-index="1"]',{visible:true});case 3:_context.next=5;return(0,_step1EnterSingleDates2.default)(page,params);case 5:_context.next=7;return(0,_step1EnterProfile2.default)(page,params);case 7:_context.next=9;return page.click('[data-step-index="1"] button.cta-button');case 9:_context.next=16;break;case 11:_context.prev=11;_context.t0=_context['catch'](0);_ref2$message=_context.t0.message;message=_ref2$message===undefined?'No error message is defined':_ref2$message;_logger2.default.error('Error in Step 1. '+message.trim());case 16:case'end':return _context.stop();}}},_callee,undefined,[[0,11]]);}));return function step1(_x2){return _ref.apply(this,arguments);};}();exports.default=function(){var _ref3=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee4(){var _ref4=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},env=_ref4.env,_ref4$lang=_ref4.lang,lang=_ref4$lang===undefined?'en':_ref4$lang,_ref4$headless=_ref4.headless,headless=_ref4$headless===undefined?true:_ref4$headless,_ref4$w=_ref4.w,width=_ref4$w===undefined?1024:_ref4$w,_ref4$h=_ref4.h,height=_ref4$h===undefined?768:_ref4$h;var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var browser,page,requestMap,client,getResponseBody,onNetworkRequestWillBeSent,onNetworkResponseReceived,onNetworkLoadingFailed,onNetworkLoadingFinished,_ref11$message,message;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _puppeteer2.default.launch({headless:headless,args:['--window-size='+width+','+height]});case 2:browser=_context4.sent;_context4.next=5;return browser.newPage();case 5:page=_context4.sent;_context4.next=8;return page.setViewport({width:width,height:height});case 8:_context4.next=10;return page.goto('http://'+env+'/'+lang+'/quote');case 10:/* BEGIN NETWORK MONITORING */requestMap=new _map2.default();_context4.next=13;return page.target().createCDPSession();case 13:client=_context4.sent;_context4.next=16;return client.send('Emulation.clearDeviceMetricsOverride');case 16:getResponseBody=function(){var _ref5=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee2(requestId){var _ref6,body;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return client.send('Network.getResponseBody',{requestId:requestId});case 2:_ref6=_context2.sent;body=_ref6.body;return _context2.abrupt('return',body);case 5:case'end':return _context2.stop();}}},_callee2,undefined);}));return function getResponseBody(_x6){return _ref5.apply(this,arguments);};}();onNetworkRequestWillBeSent=function onNetworkRequestWillBeSent(){var event=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _event$request=event.request,url=_event$request.url,method=_event$request.method;if(url.includes('omtrdc')&&method==='POST'){var requestId=event.requestId,request=event.request;requestMap.set(requestId,request);_logger2.default.info('Network.requestWillBeSent',{requestId:requestId,url:transformUrl(url),method:method});}};onNetworkResponseReceived=function onNetworkResponseReceived(_ref7){var requestId=_ref7.requestId,_ref7$response=_ref7.response,url=_ref7$response.url,status=_ref7$response.status,statusText=_ref7$response.statusText;if(requestMap.has(requestId)){_logger2.default.info('Network.responseReceived',{requestId:requestId,url:transformUrl(url),status:status,statusText:statusText});}};onNetworkLoadingFailed=function(){var _ref8=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee3(){var _ref9=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var requestId=_ref9.requestId,response=(0,_objectWithoutProperties3.default)(_ref9,['requestId']);return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!requestMap.has(requestId)){_context3.next=8;break;}_context3.t0=_logger2.default;_context3.t1=(0,_extends3.default)({},response,{requestId:requestId});_context3.next=5;return getResponseBody(requestId);case 5:_context3.t2=_context3.sent;_context3.t0.info.call(_context3.t0,'Network.loadingFailed',_context3.t1,_context3.t2);requestMap.delete(requestId);case 8:case'end':return _context3.stop();}}},_callee3,undefined);}));return function onNetworkLoadingFailed(){return _ref8.apply(this,arguments);};}();onNetworkLoadingFinished=function onNetworkLoadingFinished(_ref10){var requestId=_ref10.requestId;// , ...response }) => { // Logger.info('Network.loadingFinished', { requestId, ...response });
if(requestMap.has(requestId)){_logger2.default.info('Network.loadingFinished',{requestId:requestId});requestMap.delete(requestId);}};client.on('Network.requestWillBeSent',onNetworkRequestWillBeSent);client.on('Network.responseReceived',onNetworkResponseReceived);client.on('Network.loadingFailed',onNetworkLoadingFailed);client.on('Network.loadingFinished',onNetworkLoadingFinished);_context4.next=27;return client.send('Network.enable');case 27:_context4.prev=27;_context4.next=30;return(0,_travel.single)(page,params);case 30:_context4.next=32;return page.waitForNavigation();case 32:_context4.next=34;return step1(page,params);case 34:_context4.next=36;return step2(page,params);case 36:_context4.next=38;return step3(page,params);case 38:_context4.next=40;return step4(page,params);case 40:_context4.next=42;return page.waitForNavigation();case 42:_context4.next=44;return(0,_travel.altapay)(page,params);case 44:_context4.next=46;return page.waitForNavigation({waitUntil:['networkidle2','load']});case 46:_context4.next=53;break;case 48:_context4.prev=48;_context4.t0=_context4['catch'](27);_ref11$message=_context4.t0.message;message=_ref11$message===undefined?'No error message is defined':_ref11$message;_logger2.default.error('Error in scenario `quote-travel-single`. '+message.trim());case 53:_context4.prev=53;_context4.next=56;return client.send('Network.disable');case 56:client.removeListener('Network.requestWillBeSent',onNetworkRequestWillBeSent);client.removeListener('Network.responseReceived',onNetworkResponseReceived);client.removeListener('Network.loadingFailed',onNetworkLoadingFailed);client.removeListener('Network.loadingFinished',onNetworkLoadingFinished);/* END NETWORK MONITORING */_context4.next=62;return browser.close();case 62:return _context4.finish(53);case 63:case'end':return _context4.stop();}}},_callee4,undefined,[[27,48,53,63]]);}));return function(){return _ref3.apply(this,arguments);};}();