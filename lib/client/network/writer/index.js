'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _toConsumableArray2=require('babel-runtime/helpers/toConsumableArray');var _toConsumableArray3=_interopRequireDefault(_toConsumableArray2);var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _from=require('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _path=require('path');var _path2=_interopRequireDefault(_path);var _fsExtra=require('fs-extra');var _fsExtra2=_interopRequireDefault(_fsExtra);var _csvWriteStream=require('csv-write-stream');var _csvWriteStream2=_interopRequireDefault(_csvWriteStream);var _=require('./..');var _getDir=require('../../../get-dir');var _getDir2=_interopRequireDefault(_getDir);var _getNow=require('../../../get-now');var _getNow2=_interopRequireDefault(_getNow);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}// const isEmpty = (object = {}) => !!Reflect.ownKeys(object).length;
var isEmpty=function isEmpty(){var object=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};for(var key in object){return false;}// eslint-disable-line
return true;};exports.default=function(){var values=(0,_from2.default)(_.map.values());var timestamps=values.reduce(function(accumulator,_ref){var timestamp=_ref.timestamp;return accumulator.includes(timestamp)?accumulator:accumulator.concat(timestamp);},[]);timestamps.forEach(function(timestamp){var scenarios=values.filter(function(_ref2){var t=_ref2.timestamp;return timestamp===t;}).reduce(function(accumulator,_ref3){var scenario=_ref3.scenario;return accumulator.includes(scenario)?accumulator:accumulator.concat(scenario);},[]);scenarios.forEach(function(scenario){var iterations=values.filter(function(_ref4){var t=_ref4.timestamp,s=_ref4.scenario;return timestamp===t&&scenario===s;}).reduce(function(accumulator,_ref5){var iteration=_ref5.iteration;return accumulator.includes(iteration)?accumulator:accumulator.concat(iteration);},[]);iterations.forEach(function(){var _ref6=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function _callee(iteration){var f,p,writeStream,writer;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:f=(0,_getDir2.default)(iteration,scenario,(0,_getNow2.default)(timestamp))+'/network.csv';p=_path2.default.resolve(f);_context.next=4;return(0,_fsExtra.ensureFile)(p);case 4:writeStream=_fsExtra2.default.createWriteStream(p);writer=(0,_csvWriteStream2.default)({headers:['Index','Method','URL','Referer','Status','Status Text','Succeeded','Type','Error Text','Cancelled','Timestamp','Scenario','Iteration']});_context.next=8;return new _promise2.default(function(resolve,reject){writeStream.on('close',resolve).on('error',reject);writer.pipe(writeStream);values.filter(function(_ref7){var t=_ref7.timestamp,s=_ref7.scenario,i=_ref7.iteration;return timestamp===t&&scenario===s&&iteration===i;}).forEach(function(_ref8,index){var _ref8$request=_ref8.request,method=_ref8$request.method,url=_ref8$request.url,_ref8$request$headers=_ref8$request.headers.Referer,referer=_ref8$request$headers===undefined?'':_ref8$request$headers,_ref8$response=_ref8.response;_ref8$response=_ref8$response===undefined?{}:_ref8$response;var status=_ref8$response.status,statusText=_ref8$response.statusText,_ref8$failed=_ref8.failed,failed=_ref8$failed===undefined?{}:_ref8$failed,_ref8$failed2=_ref8.failed;_ref8$failed2=_ref8$failed2===undefined?{}:_ref8$failed2;var type=_ref8$failed2.type,errorText=_ref8$failed2.errorText,canceled=_ref8$failed2.canceled;writer.write([index,method,url,referer,status,statusText,isEmpty(failed)].concat((0,_toConsumableArray3.default)(!isEmpty(failed)?[type,errorText,canceled]:['','','']),[timestamp,scenario,iteration]));});writer.end();});case 8:case'end':return _context.stop();}}},_callee,undefined);}));return function(_x2){return _ref6.apply(this,arguments);};}());});});};