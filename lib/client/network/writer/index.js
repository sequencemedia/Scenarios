'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _from=require('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _path=require('path');var _path2=_interopRequireDefault(_path);var _fsExtra=require('fs-extra');var _fsExtra2=_interopRequireDefault(_fsExtra);var _csvWriteStream=require('csv-write-stream');var _csvWriteStream2=_interopRequireDefault(_csvWriteStream);var _=require('./..');var _getDir=require('../../../get-dir');var _getDir2=_interopRequireDefault(_getDir);var _getNow=require('../../../get-now');var _getNow2=_interopRequireDefault(_getNow);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var toValueOf=function toValueOf(string){return new Date(string).valueOf();};var isEmpty=function isEmpty(){var object=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};// const isEmpty = (object = {}) => !!Reflect.ownKeys(object).length;
for(var key in object){return false;}// eslint-disable-line
return true;};var getValues=function getValues(){return(0,_from2.default)(_.map.values());};var getTimestamps=function getTimestamps(values){return values.filter(function(_ref){var timestamp=_ref.timestamp;return!!timestamp;}).reduce(function(accumulator,_ref2){var timestamp=_ref2.timestamp;return accumulator.includes(timestamp)?accumulator:accumulator.concat(timestamp);},[]);};var getScenarios=function getScenarios(values,timestamp){return values.filter(function(_ref3){var t=_ref3.timestamp;return timestamp===t;}).reduce(function(accumulator,_ref4){var scenario=_ref4.scenario;return accumulator.includes(scenario)?accumulator:accumulator.concat(scenario);},[]);};var getIterations=function getIterations(values,timestamp,scenario){return values.filter(function(_ref5){var t=_ref5.timestamp,s=_ref5.scenario;return timestamp===t&&scenario===s;}).reduce(function(accumulator,_ref6){var iteration=_ref6.iteration;return accumulator.includes(iteration)?accumulator:accumulator.concat(iteration);},[]);};var generateFrom=function generateFrom(values){return _promise2.default.all(getTimestamps(values).map(function(timestamp){return _promise2.default.all(getScenarios(values,timestamp).map(function(scenario){return _promise2.default.all(getIterations(values,timestamp,scenario).map(function(iteration){var f=(0,_getDir2.default)(iteration,scenario,(0,_getNow2.default)(timestamp))+'/network.csv';var p=_path2.default.resolve(f);return(0,_fsExtra.ensureFile)(p).then(function(){var writeStream=_fsExtra2.default.createWriteStream(p);var writer=(0,_csvWriteStream2.default)({headers:['Index','Method','URL','Payload','Referer','Status','Status Text','Succeeded','Type','Error Text','Cancelled','Timestamp','Scenario','Iteration']});return new _promise2.default(function(resolve,reject){writeStream.on('close',resolve).on('error',reject);writer.pipe(writeStream);values.filter(function(_ref7){var t=_ref7.timestamp,s=_ref7.scenario,i=_ref7.iteration;return timestamp===t&&scenario===s&&iteration===i;}).forEach(function(_ref8,index){var _ref8$request=_ref8.request,method=_ref8$request.method,url=_ref8$request.url,_ref8$request$postDat=_ref8$request.postData,payload=_ref8$request$postDat===undefined?'':_ref8$request$postDat,_ref8$request$headers=_ref8$request.headers.Referer,referer=_ref8$request$headers===undefined?'':_ref8$request$headers,_ref8$response=_ref8.response;_ref8$response=_ref8$response===undefined?{}:_ref8$response;var status=_ref8$response.status,statusText=_ref8$response.statusText,_ref8$failed=_ref8.failed,failed=_ref8$failed===undefined?{}:_ref8$failed,_ref8$failed2=_ref8.failed;_ref8$failed2=_ref8$failed2===undefined?{}:_ref8$failed2;var type=_ref8$failed2.type,errorText=_ref8$failed2.errorText,canceled=_ref8$failed2.canceled;writer.write([index,method,url,payload,referer,status,statusText,isEmpty(failed),type,errorText,canceled,toValueOf(timestamp),scenario,iteration]);});writer.end();});});}));}));}));};exports.default=function(){return generateFrom(getValues());};